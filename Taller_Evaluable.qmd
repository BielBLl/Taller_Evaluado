---
title: "Taller evaluado de repaso para el Primer Parcial"
subtitle: "20582- Análisis de Datos para el GMAT"
format:
  html:
    theme: lumen
    toc: true
    toc-depth: 3
Rendering:
    embed-resources: true
---
```{r}
library(MASS)
library(GGally)
library(ggplot2)
library(dplyr)
library(XNomial)
```

Elige un tema que te interese (finanzas, medio ambiente, educación, cine, entre otros). En este taller, aplicarás los pasos del método científico (ver sección 1.1 de los apuntes de la asignatura) para abordar, con datos simulados, una problemática relacionada con el tema elegido. Deberás presentar un informe de tu proyecto siguiendo la estructura detallada en el documento “Recomendaciones para escribir informes de proyectos en Estadística,” que se encuentra en la sección "Práctica" de la página del curso en Aula Digital.

### Primer paso: 

Define los objetivos de tu trabajo: Describe la hipótesis general que deseas investigar y especifica los objetivos específicos necesarios para validar o refutar dicha hipótesis.

Nos centraremos en el estudio de internación hospitalaria en España, definiremos como variables cuantitativas "altura","horas_de_sueño","tiempo_hasta_hospitalizacion" i "edad"
donde la altura está en centímetros y el tiempo hosta hospitalización en días, esté último intenta reflejar el efecto de tardar demasiado a acudir a un serivició de salud.

Para las ordinales escogemos expectativa, cantidad de dolor y calidad de la estancia. De los tres, el más interesante es la expectativa de los individuos de mejorar o no y poder-lo comparar posteriormente a la razón de alta.

Para finalizar escogemos como nominales el sexo y la razón de alta.

Claramente, al ser datos creados, careceran de sentido estos estudios pero procedemos imaginando que son valores genuinos.

Algunas de las hipótesis que nos podríamos plantear: 

- Posible relación Edad-Tiempo hasta hospitalización
Para este objetivo necesitamos ver un test de correlación entre las dos variables y ver si esta es o no lo suficiente alta

- Relación horas de sueño con cantidad de dolor 
Similar a lo anterior con un Heat Map podremos solucionar-lo

- Gente con bajas expectativas implica mayor incidencia de defunción y análogo con altas expectativas

Podemos usar contraste de hipótesis simple donde la hipótesis nula sea que la probabilidad de defunción con bajas expectativas sea mayor que por ejemplo la de expectativa estable.

Nos centraremos en este último apartado ya que nos da la oportunidad de hacer contrastes de hipótesis

### Segundo paso:

Define las variables clave para probar tu hipótesis. Asegúrate de incluir al menos cuatro variables cuantitativas, tres ordinales y dos nominales. Indica las unidades de medida para las variables cuantitativas y los niveles para las variables nominales y ordinales. A continuación, simula los datos en R de acuerdo a las siguientes pautas:

* **Tabla 1**: Genera una tabla con al menos 100 observaciones y las variables definidas en el paso anterior, asegurate que las variables cuantitativas sigan una distribución normal multivariante.

```{r}
media <- c(170, 7, 13, 40)  # Medias de horas_estudio, horas_sueno, tiempo_traslado, promedio_calificaciones
covarianza <- matrix(c(15, 2, 5, 1,
                       2, 6, 3, 1,
                       5, 3, 20, 2,
                       1, 1, 2, 1.5), 
                     nrow = 4, ncol = 4)


set.seed(2025)
datos_numericos <- mvrnorm(150, mu = media, Sigma = covarianza)
# Usaremos dos variables cuantitativa del 0 al 10 para la calidad de la estancia y cantidad de dolor
estancia_hospitales<-data.frame(
  #4 Cuantitativas 
  
  altura = round(datos_numericos[,1],digits = 1),
  horas_sueno = round(datos_numericos[,2]),
  tiempo_hasta_hospitalizacion = round(datos_numericos[,3],1),
  edad = round(datos_numericos[,4],1),
  
  #3 Ordinales 
  expectativa=ordered(sample(1:3, 150, replace = TRUE), labels = c("Empeorar","Estable","Mejorar")),
  cantidad_dolor = ordered(sample(1:5, 150, replace = TRUE), labels = c("Muy Bajo", "Bajo", "Medio", "Alto", "Muy Alto")),
  calidad_estancia = ordered(sample(1:5, 150, replace = TRUE), labels = c("Muy Mala","Mala","Normal","Buena", "Muy Buena")),

  #2 Nominales 
  
  sexo=sample(c("Hombre","Mujer"),150,replace=TRUE),
  razon_alta=sample(c("Mejoria","Traslado","Fallecimiento","Otras Causas"),150,replace=TRUE)
  
  
)
glimpse(estancia_hospitales)
```

* **Tabla 2**: Consigue algunos datos en Internet que puedas utilizar para ayudar a resolver tu problema (una variable o dos basta), algunas ideas de dónde buscar son: [datos abiertos del Gobierno de España](https://datos.gob.es/es/), [INE](https://www.ine.es/ss/Satellite?L=0&c=Page&cid=1259942408928&p=1259942408928&pagename=ProductosYServicios%2FPYSLayout), [Kaggle](https://www.kaggle.com/), etc. 


Une ambas tablas utilizando un identificador simulado en una base de datos única. Emplea las funciones del paquete tidyverse explicadas en la sección 1.7.5 de los apuntes de la asignatura. Esta parte es opcional, pero te permitirá enriquecer tu base de datos y realizar análisis más completos.

Usaremos el siguiente data.frame [Estancia Media](https://datos.gob.es/es/catalogo/ea0010587-estancia-media-segun-el-sexo-el-motivo-del-alta-y-el-diagnostico-principal-identificador-api-tpx-sociedad_2589-salud_2590-emh_8591-a2022_11029-l0-01018-px) para añadir información a los valores generados, imaginemos que la población de estudio sufren turberculossi, denotado por el codigo 0103 en el data.frame del GOB.

Los dias que sulen estar hospitalizados hasta darse de alta son 21.57 para ambos sexos, 24.3 para hombres y 15.66 para mujeres. entonces es una variable normal con una sigma desconocida que nos inventaremos ya que no hay informació de esta.

Si la media de dias ingresado es de unos 21.57 podemos imaginarnos que no puede tener gran desviación debido a la naturaleza de la tuberculosis, pongamos $sigma^2=3$

Entonces esta variable $X\sim N(21.57,3)$, hacemos una simulación de 150 datos y la añadimos al dataframe inicial:

```{r}
duracion_estancia<-rnorm(150,mean=21.57,sd=3)
duracion_estancia
```



### Tercer paso

Realiza un análisis descriptivo multivariantes de tu base de datos de acuerdo a los objetivos de tu trabajo. Describe lo observado en el contexto del problema. 

Primero veremos si existe alguna correlación entre Edad-Tiempo hasta hospitalización y Horas de sueño- Dolor, usaremos la función gg pairs para conseguirlo.
```{r}
dt<-estancia_hospitales %>%select(1:5,cantidad_dolor,sexo)
dt$sexo<-c(1,2)
glimpse(dt)
p<-ggpairs(dt)
p
```
Magicamente ,aun siendo datos simulados, podemos ver una leve correlación entre edad y tiempo has hospitalización. Aunque muchas de nuestras variables muestran cierta correlación menos con el sexo.

Veamos mas de cerca el gráfico de puntos que nos aporta ggpairs:
```{r}
p[4,3]
```
Podemos intuir una regresión lineal gracias al gráfico, ya que a mayor edad, mayor el tiempo hasta hospitalización de medio.
```{r}
modelo<-lm(data=dt,tiempo_hasta_hospitalizacion~edad)
summary(modelo)
```
El modelo nos dice claramente que hay un gran error mínimo, por lo que no se ajusta bien a los puntos, debido al valor bajísimo de R_squared=0.1452. Por lo tanto negamos que pueda seguir una modelo de regresión lineal.

Añadimos la recta de regresión al gráfico anterior
```{r}
plot(dt$edad,dt$tiempo_hasta_hospitalizacion,main="Regresión Lineal")
abline(modelo,col="red")
```
Al añadir la recta podemos ver claramente lo mal ajustada que está a los puntos de la gráfica.

Respecto la relación Horas de Sueño-Dolor, podemos veamos mas en detalle el estudio con boxplots que nos ofrece ggpairs
```{r}
p[2,6]
```
De nuevo, al ser datos simulados pueden carecer de sentido. Por lo que parece, estadísticament hablando la diferencia de horas de sueño de media no varia, carece de sentido ya que a mayor dolor mejor duerme en general los pacientes. 

Pacientes con valores de dolor bajo parecen tener un sueño mas consistente, menos algunos valores atípicos. Si los pacientes con valores muy bajos de dolor tuviesen sueño consistente podríamos intuir alguna relación.
 La media de horas de sueño ronda las 6.8 horas, lo qual es mas o menos normal debido a la edad de los sujetos, la cual ronda los 40.

```{r}
mean(dt$horas_sueno)
mean(dt$edad)
```
Para las variables cuantitativas de tu base de datos, calcula e interpreta la información que proporciona la varianza generalizada y la varianza total.

Encontremos la matriz de convarianzas de los datos cuantitativos primero:
```{r}
dt1<-dt %>% select(1:4)
S<-cov(dt1)
vap<-eigen(S)$values
```
Ahora que tenemos tanto la matriz como sus valores própios, podemos calcular la varianza generalizada y la varianza total.

```{r}
v_total<-sum(vap)
v_gen<-prod(vap)
v_gen
v_total
```
Por lo que obtenoms una varianza generalizada de 1952.75 y una varianza total de 41.64.

Al entender la varianza generalizada como la dispersión global del conjunto de variables dadas, podemos ver como tiene un valor altíssimo, seguramente debido a que las variables están simuladas aleatoriamente.

En cambio, la varianza total como media general de dispersión está relativamente baja si tenemos en cuenta que algunos valores como la altura fluctuan mucho por construcción.


### Cuarto paso

Selecciona una de las variables no cuantitativas y modelízala con una distribución multinomial, debes estimar sus parámetros. Utiliza el modelo para calcular la probabilidad de que ocurra un evento de interés en una muestra de tamaño 20, relevante para tu problema.

De las variables no cuantitativas las mas interesantes son calidad de la estancia i cantidad de dolor, escogeremos la cantidad de dolor ya que anteriormente la hemos estudiado un poco.

Usaremos el paquete XNomial para ver si sigue
```{r}
#amagar aixo
table(dt$cantidad_dolor)
observaciones=c(25,32,32,32,29)
freq_teorica=c(2,3,3,3,2)/sum(c(2,3,3,3,2))
```


```{r}
resultado<-xmulti(obs=observaciones,expr=freq_teorica)
```
Al ser

### Quinto paso

Con las variables cuantitativas de tu base de datos, ajusta un modelo de regresión multivariante en la forma:

$$Y=\beta_0+\beta_1 X_1+ \cdots + \beta_p X_p + \epsilon$$
Donde $Y$ es la variable cuantitativa que deseas explicar en función del resto de variables cuantitativas registradas. Además, calcula la función de score e interpreta su resultado en el contexto del problema.

### Sexto paso

Realiza un contraste de hipótesis de dos medias multivariante que sea relevante para tu problema. Por ejemplo, podrías evaluar si el vector de medias de la variable cuantitativa de interés $Y$ es el mismo para dos niveles distintos de la variable no cuantitativa que modelaste como multinomial en el paso anterior. Ejecuta el contraste tanto teóricamente como con la función hotelling.test en R. Escribe la conclusión del contraste en el contexto de tu problema.

### Último paso

Recuerda que:

* De acuerdo con las recomendaciones para redactar informes de proyectos en Estadística, tu informe debe incluir conclusiones, recomendaciones y bibliografía.

* Crea un repositorio en GitHub para tu proyecto y asegúrate de añadir en el encabezado YAML la siguiente opción necesaria para la renderización sin problemas:


```{r, eval=FALSE}
Rendering:
    embed-resources: true

```

¡Buena suerte y disfruta del proceso!






